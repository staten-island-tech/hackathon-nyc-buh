<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Charged Ammo with Health Bars</title>
  <style>
    body {
      cursor: none;
      margin: 0;
      overflow: hidden;
      height: 100vh;
    }

    #custom-cursor {
      position: fixed;
      width: 64px;
      height: 64px;
      pointer-events: none;
      z-index: 1000;
      transform: translate(-50%, -50%);
    }

    .ammo {
      position: fixed;
      width: 128px;
      height: 128px;
      pointer-events: none;
      z-index: 999;
      transform-origin: center center;
      transform: translate(-50%, -50%) scale(1);
    }

    .explosion {
      position: fixed;
      width: 128px;
      height: 128px;
      pointer-events: none;
      z-index: 998;
      transform: translate(-50%, -50%);
      animation: fadeOut 0.4s ease-out forwards;
    }

    .enemy {
      position: fixed;
      width: 64px;
      height: 64px;
      background-image: url("{{ url_for('static', filename='enemy.png') }}");
      background-size: cover;
      z-index: 997;
      pointer-events: none;
    }

    .health-bar {
      position: fixed;
      width: 64px;
      height: 6px;
      background-color: red;
      border: 1px solid #000;
      border-radius: 3px;
      z-index: 1001;
      pointer-events: none;
    }

    .health-fill {
      height: 100%;
      background-color: limegreen;
      border-radius: 2px;
      transition: width 0.2s ease;
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.5);
      }
    }
  </style>
</head>
<body>
  <img id="custom-cursor" src="{{ url_for('static', filename='aim.png') }}" alt="Cursor" />

  <script>
    const cursor = document.getElementById("custom-cursor");

    document.addEventListener("mousemove", (e) => {
      cursor.style.left = e.clientX + "px";
      cursor.style.top = e.clientY + "px";
    });

    const enemies = [];

    function getQuadraticBezierXY(t, startX, startY, cpX, cpY, endX, endY) {
      const x = Math.pow(1 - t, 2) * startX + 2 * (1 - t) * t * cpX + Math.pow(t, 2) * endX;
      const y = Math.pow(1 - t, 2) * startY + 2 * (1 - t) * t * cpY + Math.pow(t, 2) * endY;
      return { x, y };
    }

    function spawnEnemy() {
      const enemy = document.createElement("div");
      enemy.className = "enemy";
      enemy.style.left = Math.random() * (window.innerWidth - 64) + "px";
      enemy.style.top = Math.random() * (window.innerHeight - 200) + "px";
      enemy.hp = 3;
      enemy.maxHp = 3;

      const healthBar = document.createElement("div");
      healthBar.className = "health-bar";
      const healthFill = document.createElement("div");
      healthFill.className = "health-fill";
      healthFill.style.width = "100%";
      healthBar.appendChild(healthFill);

      document.body.appendChild(enemy);
      document.body.appendChild(healthBar);

      enemy.healthBar = healthBar;
      enemy.healthFill = healthFill;

      enemies.push(enemy);
      moveEnemy(enemy);
      updateHealthBarPosition(enemy);
    }

    function moveEnemy(enemy) {
      const move = () => {
        const x = Math.random() * (window.innerWidth - 64);
        const y = Math.random() * (window.innerHeight - 200);
        enemy.style.transition = "left 2s linear, top 2s linear";
        enemy.style.left = x + "px";
        enemy.style.top = y + "px";

        setTimeout(() => {
          updateHealthBarPosition(enemy);
        }, 10);

        if (enemy.hp > 0) {
          setTimeout(() => moveEnemy(enemy), 2000);
        }
      };
      move();
    }

    function updateHealthBarPosition(enemy) {
      if (!enemy.healthBar) return;
      const rect = enemy.getBoundingClientRect();
      enemy.healthBar.style.left = rect.left + "px";
      enemy.healthBar.style.top = rect.top - 10 + "px";
    }

    function checkExplosionDamage(x, y, chargeRatio) {
      const minRadius = 80;
      const maxRadius = 250;
      const radius = minRadius + (maxRadius - minRadius) * chargeRatio;
      const minDamage = 1;
      const maxDamage = 3;
      const damage = minDamage + (maxDamage - minDamage) * chargeRatio;

      enemies.forEach((enemy, i) => {
        const rect = enemy.getBoundingClientRect();
        const ex = rect.left + rect.width / 2;
        const ey = rect.top + rect.height / 2;
        const dist = Math.hypot(x - ex, y - ey);
        if (dist < radius) {
          enemy.hp -= damage;
          if (enemy.hp < 0) enemy.hp = 0;
          enemy.healthFill.style.width = (enemy.hp / enemy.maxHp) * 100 + "%";
          enemy.style.filter = `brightness(${0.6 + (enemy.hp / enemy.maxHp) * 0.4})`;

          if (enemy.hp <= 0) {
            enemy.remove();
            if (enemy.healthBar) enemy.healthBar.remove();
            enemies.splice(i, 1);
          }
        }
      });
    }

    let charging = false;
    let chargeStart = 0;
    let chargeScale = 1.5;
    let chargeInterval = null;
    let chargeAmmo = null;
    const maxChargeTime = 3000; // max charge 3 seconds
    let chargeRatio = 0; // 0 to 1

    document.addEventListener("mousedown", (e) => {
      charging = true;
      chargeStart = Date.now();
      chargeScale = 1.5;
      chargeRatio = 0;

      chargeAmmo = document.createElement("img");
      chargeAmmo.src = "{{ url_for('static', filename='ammo.png') }}";
      chargeAmmo.className = "ammo";
      chargeAmmo.style.left = (window.innerWidth - 80) + "px";
      chargeAmmo.style.top = (window.innerHeight - 100) + "px";
      document.body.appendChild(chargeAmmo);

      chargeInterval = setInterval(() => {
        const elapsed = Date.now() - chargeStart;
        chargeRatio = Math.min(elapsed / maxChargeTime, 1);
        chargeScale = 1.5 + chargeRatio * 1.5; // scale from 1.5 to 3
        chargeAmmo.style.transform = `translate(-50%, -50%) scale(${chargeScale.toFixed(2)})`;

        if (chargeRatio >= 1) {
          chargeAmmo.src = "{{ url_for('static', filename='charged_ammo.png') }}";
        }
      }, 50);
    });

    document.addEventListener("mouseup", (e) => {
      if (!charging) return;
      charging = false;
      clearInterval(chargeInterval);

      const startX = window.innerWidth - 80;
      const startY = window.innerHeight - 100;
      const endX = e.clientX;
      const endY = e.clientY;
      const cpX = startX;
      const cpY = endY - 200;

      // Adjust duration so ammo flies faster the longer you charge
      const minDuration = 300; // fastest
      const maxDuration = 1000; // slowest
      const duration = maxDuration - chargeRatio * (maxDuration - minDuration);

      const ammo = chargeAmmo;
      let startTime = null;

      function animate(time) {
        if (!startTime) startTime = time;
        const elapsed = time - startTime;
        let t = Math.min(elapsed / duration, 1);
        const pos = getQuadraticBezierXY(t, startX, startY, cpX, cpY, endX, endY);
        const scale = chargeScale + t * (0.3 - chargeScale);
        ammo.style.left = pos.x + "px";
        ammo.style.top = pos.y + "px";
        ammo.style.transform = `translate(-50%, -50%) scale(${scale.toFixed(2)})`;

        if (t < 1) {
          requestAnimationFrame(animate);
        } else {
          ammo.remove();
          const boom = document.createElement("img");
          boom.src = "{{ url_for('static', filename='boom.png') }}";
          boom.className = "explosion";

          const baseSize = 128;
          const explosionSize = baseSize + chargeRatio * 192;
          boom.style.width = explosionSize + "px";
          boom.style.height = explosionSize + "px";

          boom.style.left = endX + "px";
          boom.style.top = endY + "px";
          document.body.appendChild(boom);

          checkExplosionDamage(endX, endY, chargeRatio);

          setTimeout(() => boom.remove(), 400);
        }
      }

      requestAnimationFrame(animate);
    });

    setInterval(() => {
      if (enemies.length < 10) spawnEnemy();
    }, 2000);

    function updateHealthBars() {
      enemies.forEach(enemy => {
        updateHealthBarPosition(enemy);
      });
      requestAnimationFrame(updateHealthBars);
    }
    updateHealthBars();

  </script>
</body>
</html>
